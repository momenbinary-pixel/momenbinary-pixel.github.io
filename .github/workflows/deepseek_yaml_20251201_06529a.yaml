name: Code Quality

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '0 8 * * 1' # Weekly on Monday at 8 AM

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        if: exists('package.json')
        run: npm ci
      
      - name: HTML Validation
        run: |
          echo "üîç Validating HTML files..."
          # Install html5validator if not present
          pip install html5validator || true
          # Validate HTML files
          find . -name "*.html" -exec html5validator {} \; || echo "HTML validation completed"
      
      - name: CSS Validation
        run: |
          echo "üé® Checking CSS..."
          if command -v csslint &> /dev/null; then
            find . -name "*.css" -exec csslint {} \; || echo "CSS check completed"
          else
            echo "csslint not installed, skipping CSS validation"
          fi
      
      - name: JavaScript Linting
        run: |
          echo "üìù Linting JavaScript..."
          if [ -f "package.json" ]; then
            npx eslint *.js || echo "ESLint check completed"
          else
            # Simple syntax check
            for file in *.js; do
              if [ -f "$file" ]; then
                node -c "$file" && echo "‚úÖ $file syntax is valid"
              fi
            done
          fi
      
      - name: Check for broken links
        run: |
          echo "üîó Checking for broken links..."
          # Install link checker
          pip install linkchecker || true
          linkchecker --check-extern index.html || echo "Link check completed"
      
      - name: Security Scan
        uses: snyk/actions/node@master
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  accessibility-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Accessibility Check
        run: |
          echo "‚ôø Running accessibility checks..."
          npm install -g pa11y-ci || true
          # Run accessibility tests on key pages
          pa11y-ci --sitemap http://localhost:8080 || echo "Accessibility check completed"
        continue-on-error: true